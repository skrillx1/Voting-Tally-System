<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Live Tally View</title>
  <link href="css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/all.min.css">
  <style>
    body {
      background: #f4f6f9;
    }
    .card {
      border-radius: 1rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .highlight {
      animation: highlight 3s ease-out;
    }
    @keyframes highlight {
      from { background-color: #22b40c70; }
      to { background-color: transparent; }
    }
    .leader-icon {
      color: #ffc107; /* gold */
      margin-left: 5px;
    }
    td[contenteditable="true"] {
      background: #fff9e6;
      border: 1px dashed #ccc;
      cursor: text;
    }
    td[contenteditable="true"]:focus {
      outline: 2px solid #007bff;
    }
  </style>
</head>
<body class="p-4">
  <div class="container">
    <h1 class="mb-4 text-center text-primary fw-bold">
      <i class="fa-solid fa-chart-line"></i> Live Voting Results
    </h1>

    <!-- Tally Results -->
    <div class="card">
      <div class="card-header bg-primary text-white">
        <i class="fa-solid fa-table me-2"></i> Tally Results
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover align-middle" id="tallyTable">
            <thead class="table-light">
              <tr>
                <th>Candidate</th>
                <th>Vice 1</th>
                <th>Vice 2</th>
                <th>Treasurer</th>
                <th>Auditor</th>
                <th>Membership</th>
                <th>Information</th>
                <th>Social</th>
                <th>Civic</th>
                <th>Property Custodian</th>
              </tr>
            </thead>
            <tbody id="resultsBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    const positions = ["Vice 1","Vice 2","Treasurer","Auditor","Membership","Information","Social","Civic","Property Custodian"];
    let previousTallies = {};

    function renderData() {
      const candidates = JSON.parse(localStorage.getItem("candidates")) || {};
      const tallies = JSON.parse(localStorage.getItem("tallies")) || {};
      const resultsBody = document.getElementById("resultsBody");

      const maxPerPosition = {};
      positions.forEach(pos => {
        let maxVotes = 0;
        Object.keys(candidates).forEach(id => {
          const votes = tallies[id]?.[pos] || 0;
          if (votes > maxVotes) maxVotes = votes;
        });
        maxPerPosition[pos] = maxVotes;
      });

      resultsBody.innerHTML = "";
      Object.entries(candidates).forEach(([id, name]) => {
        const tr = document.createElement("tr");

        let cells = positions.map(pos => {
          const votes = tallies[id]?.[pos] || 0;
          const isLeader = votes === maxPerPosition[pos] && votes > 0;
          const oldVotes = previousTallies[id]?.[pos] || 0;
          const increased = votes > oldVotes;

          return `<td 
                    contenteditable="true" 
                    data-id="${id}" 
                    data-pos="${pos}" 
                    class="${increased ? 'highlight' : ''}">
            ${votes}${isLeader ? ' <i class="fa-solid fa-trophy leader-icon"></i>' : ''}
          </td>`;
        }).join("");

        tr.innerHTML = `
          <td contenteditable="true" data-id="${id}" data-pos="name" class="fw-bold">
            ${id} - ${name}
          </td>
          ${cells}
        `;
        resultsBody.appendChild(tr);
      });

      previousTallies = JSON.parse(JSON.stringify(tallies));
    }

    // Save edits (on blur or Enter) and re-render immediately
    function saveCell(e) {
      if (!e.target.matches("td[contenteditable='true']")) return;

      const id = e.target.dataset.id;
      const pos = e.target.dataset.pos;
      const candidates = JSON.parse(localStorage.getItem("candidates")) || {};
      const tallies = JSON.parse(localStorage.getItem("tallies")) || {};

      let value = e.target.innerText.trim();

      if (pos === "name") {
        const parts = value.split("-");
        if (parts.length > 1) {
          candidates[id] = parts[1].trim();
        } else {
          candidates[id] = value;
        }
        localStorage.setItem("candidates", JSON.stringify(candidates));
      } else {
        const newVotes = parseInt(value.replace(/\D/g, "")) || 0;
        if (!tallies[id]) tallies[id] = {};
        tallies[id][pos] = newVotes;
        localStorage.setItem("tallies", JSON.stringify(tallies));
      }

      renderData(); // update immediately in this tab
    }

    // Blur event → save changes
    document.addEventListener("blur", saveCell, true);

    // Enter key → save changes immediately
    document.addEventListener("keydown", function(e) {
      if (e.target.matches("td[contenteditable='true']") && e.key === "Enter") {
        e.preventDefault(); // prevent line break
        e.target.blur();    // triggers saveCell()
      }
    });

    // Listen for storage updates (other tabs or programmatic changes)
    window.addEventListener("storage", function(event) {
      if (event.key === "candidates" || event.key === "tallies") {
        renderData();
      }
    });

    // Initial render
    renderData();
  </script>
</body>
</html>
